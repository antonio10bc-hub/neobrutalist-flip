<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google Tag Manager -->
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
      </script>
    <!-- End Google Tag Manager -->
    
    <!-- FIREBASE SCRIPTS (COMPAT VERSION 9) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Coinfliip</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
      :root {
        --lime: #c6ff33;
        --lime-soft: #e8ff9f;
        --black: #050505;
        --white: #f7f7f7;
        --gray: #a0a0a0;
        --green-trend: #2ecc71;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: stretch;
        justify-content: center;
        padding: 16px;
        background: var(--lime);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'SF Pro Text',
          sans-serif;
        color: var(--black);
      }

      /* --- UTILITIES --- */
      .hidden {
        display: none !important;
      }

      /* --- FX CONTAINERS --- */
      .fx-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        pointer-events: none;
        z-index: 9999;
        overflow: hidden;
      }

      /* FIRE PARTICLES */
      .fire-particle {
        position: absolute;
        user-select: none;
        filter: drop-shadow(3px 3px 0 var(--black));
        animation: firePulse 0.8s infinite alternate ease-in-out;
        line-height: 1;
      }

      @keyframes firePulse {
        0% { transform: scale(1) rotate(-5deg); }
        100% { transform: scale(1.2) rotate(5deg); }
      }

      /* SAD PARTICLES */
      .sad-particle {
        position: absolute;
        user-select: none;
        font-size: 2.5rem;
        filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.2));
        animation: sadFall 0.75s forwards ease-in;
        opacity: 1;
      }

      @keyframes sadFall {
        0% { transform: translateY(0) rotate(0deg); opacity: 1; }
        100% { transform: translateY(100px) rotate(20deg); opacity: 0; }
      }

      /* HAPPY PARTICLES */
      .happy-particle {
        position: absolute;
        user-select: none;
        font-size: 2.5rem;
        filter: drop-shadow(2px 2px 0 rgba(255,255,255,0.5));
        animation: happyRise 1.2s forwards ease-out;
        opacity: 1;
        z-index: 10000;
      }

      @keyframes happyRise {
        0% { transform: translateY(0) scale(0.5); opacity: 1; }
        50% { transform: translateY(-80px) scale(1.2); opacity: 1; }
        100% { transform: translateY(-150px) scale(1); opacity: 0; }
      }

      /* --- APP CONTAINER --- */
      .app {
        width: min(960px, 100%);
        background: var(--white);
        border: 4px solid var(--black);
        box-shadow: 12px 12px 0 var(--black);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative; 
        z-index: 1;
      }

      /* --- MENU STYLES --- */
      .menu-content {
        display: flex;
        flex-direction: column;
        gap: 16px;
        align-items: center;
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
      }

      .menu-btn {
        width: 100%;
        padding: 16px;
        font-weight: 800;
        text-transform: uppercase;
        border: 4px solid var(--black);
        background: var(--lime); 
        color: var(--black);
        cursor: pointer;
        font-size: 1.1rem;
        box-shadow: 6px 6px 0 var(--black);
        transition: transform 0.1s, box-shadow 0.1s;
        letter-spacing: 0.08em;
        text-align: center;
        font-family: inherit;
      }

      .menu-btn:active {
        transform: translate(3px, 3px);
        box-shadow: 3px 3px 0 var(--black);
      }

      .menu-btn.secondary {
        background: var(--white);
      }
      
      .menu-btn.join-btn {
        background: var(--black);
        color: var(--lime);
        border-color: var(--black);
      }

      .menu-input {
        width: 100%;
        padding: 16px;
        border: 4px solid var(--black);
        background: var(--white);
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--black);
        box-shadow: 4px 4px 0 var(--black);
        text-transform: uppercase;
        text-align: center;
        letter-spacing: 0.1em;
        font-family: inherit;
        transition: transform 0.1s, box-shadow 0.1s;
      }
      
      .menu-input:focus {
        outline: none;
        transform: translate(2px, 2px);
        box-shadow: 2px 2px 0 var(--black);
        background: var(--lime-soft);
      }

      .menu-input::placeholder {
        color: var(--gray);
        text-transform: none;
        letter-spacing: 0;
        font-weight: 500;
      }

      .menu-separator {
        width: 100%;
        height: 4px;
        background: var(--black);
        margin: 10px 0;
        opacity: 0.1;
      }
      
      .menu-row {
        display: flex; 
        gap: 12px; 
        width: 100%;
      }
      
      @media (max-width: 600px) {
        .menu-row {
            flex-direction: column;
        }
      }

      /* --- HEADER & GAME --- */
      .header {
        border-bottom: 4px solid var(--black);
        background: var(--lime-soft);
        padding: 24px 20px 32px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
      }

      .header-title {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        font-size: 0.9rem;
      }

      .header-badge {
        padding: 4px 10px;
        border-radius: 999px;
        border: 2px solid var(--black);
        background: var(--white);
      }

      .coin-panel {
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 24px;
        width: 100%;
        align-items: center;
      }

      @media (max-width: 720px) {
        .header {
          padding-top: 48px;
          gap: 40px;
        }

        .header-title {
          flex-direction: column;
          align-items: flex-start;
          gap: 12px;
        }

        .coin-panel {
          grid-template-columns: 1fr;
          margin-top: 24px;
        }

        .header-badge {
          font-size: 0.6rem;
          padding: 3px 6px;
          letter-spacing: 0.03em;
        }

        .coin-wrapper {
          margin-top: 32px;
        }

        .toast {
          font-size: 0.7rem;
          padding: 6px 12px;
          max-width: 90%;
          width: auto;
          white-space: nowrap;
        }
      }

      .coin-wrapper {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
      }

      .coin {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        border: 4px solid var(--black);
        background: var(--white);
        box-shadow: 8px 8px 0 var(--black);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.26rem;
        font-weight: 800;
        color: var(--black);
        cursor: pointer;
        outline: none;
        transition:
          transform 120ms ease-out,
          box-shadow 120ms ease-out,
          background 120ms ease-out;
      }

      .coin:active {
        transform: translate(4px, 4px);
        box-shadow: 2px 2px 0 var(--black);
        background: var(--lime-soft);
      }

      .coin-face-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-top: 4px;
      }

      .coin-face-label.cta {
        animation: ctaPulse 1s ease-in-out infinite;
      }

      @keyframes ctaPulse {
        0%,
        100% {
          opacity: 0.5;
          transform: translateY(0);
        }
        50% {
          opacity: 1;
          transform: translateY(-2px);
        }
      }

      .speech-bubble {
        position: absolute;
        top: -52px;
        left: 50%;
        transform: translateX(-50%);
        padding: 6px 14px;
        background: var(--black);
        color: var(--lime);
        border-radius: 999px;
        font-weight: 800;
        font-size: 1.1rem;
        box-shadow: 4px 4px 0 var(--black);
        border: 2px solid var(--white);
        white-space: nowrap;
      }

      .speech-bubble::after {
        content: '';
        position: absolute;
        bottom: -6px;
        left: 50%;
        transform: translateX(-50%);
        border-width: 6px 6px 0 6px;
        border-style: solid;
        border-color: var(--black) transparent transparent transparent;
      }

      .coin-info {
        font-size: 0.9rem;
        line-height: 1.4;
      }

      .coin-info p {
        margin: 4px 0;
      }

      .coin-info strong {
        text-transform: uppercase;
      }

      .claim-wrapper {
        margin-top: 12px;
      }

      .claim-button {
        margin-top: 12px;
        padding: 10px 24px;
        border-radius: 999px;
        border: 3px solid var(--black);
        background: var(--lime);
        color: var(--black);
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 0.8rem;
        cursor: pointer;
        box-shadow: 6px 6px 0 var(--black);
        transition:
          transform 120ms ease-out,
          box-shadow 120ms ease-out,
          background 120ms ease-out,
          opacity 120ms ease-out;
      }

      .claim-button:disabled {
        opacity: 0.4;
        cursor: default;
        box-shadow: 0 0 0 var(--black);
        transform: none;
      }

      .claim-button:not(:disabled):active {
        transform: translate(3px, 3px);
        box-shadow: 2px 2px 0 var(--black);
        background: var(--white);
      }

      .result-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        margin-top: 8px;
        border-radius: 999px;
        border: 2px solid var(--black);
        background: var(--white);
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        transition: background-color 200ms ease, color 200ms ease, transform 200ms ease, box-shadow 200ms ease;
      }

      .result-pill.highlight {
        background-color: var(--lime) !important;
        color: var(--white) !important;
        transform: scale(1.1);
        box-shadow: 4px 4px 0 var(--black);
        text-shadow: 1px 1px 0 var(--black), -1px -1px 0 var(--black), 1px -1px 0 var(--black), -1px 1px 0 var(--black);
        border-color: var(--black);
      }

      .result-pill span {
        font-weight: 700;
      }

      .main {
        padding: 24px 20px 28px;
        background: var(--white);
      }

      .leaderboard-section {
        border-radius: 18px 18px 0 0;
        border: 3px solid var(--black);
        padding: 18px 16px 20px;
        background: #ffffff;
        box-shadow: 8px 8px 0 var(--black);
      }

      .leaderboard-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 12px;
        margin-bottom: 16px;
      }

      .leaderboard-header h1 {
        margin: 0;
        font-size: 1.4rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .leaderboard {
        border-radius: 12px;
        overflow: hidden;
        border: 2px solid var(--black);
      }

      .leaderboard-row {
        display: grid;
        grid-template-columns: 56px minmax(0, 1.4fr) minmax(0, 1fr);
        align-items: center;
        padding: 8px 12px;
        border-bottom: 2px solid var(--black);
        font-size: 0.9rem;
        background: var(--white);
      }

      .leaderboard-row:last-child {
        border-bottom: none;
      }

      .leaderboard-row:nth-child(odd) {
        background: #f1f1f1;
      }

      .leaderboard-row.is-user {
        background: var(--lime-soft);
      }

      .leaderboard-pos {
        font-weight: 800;
      }

      .leaderboard-name {
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .leaderboard-score {
        text-align: right;
        font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo,
          Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
      }

      .leaderboard-tag {
        display: inline-block;
        padding: 1px 6px;
        border-radius: 999px;
        border: 1px solid var(--black);
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        white-space: nowrap;
      }

      /* Trend indicators */
      .trend-icon {
        font-weight: 800;
        font-size: 0.8rem;
        line-height: 1;
        display: inline-block;
        opacity: 0;
        transition: opacity 200ms ease;
      }
      
      .trend-icon.visible {
        opacity: 1;
      }

      .trend-up { color: var(--green-trend); }
      .trend-down { color: var(--black); }
      .trend-equal { color: var(--gray); }

      .toast {
        position: fixed;
        left: 50%;
        bottom: 24px;
        transform: translateX(-50%);
        padding: 8px 14px;
        background: var(--black);
        color: var(--lime);
        border-radius: 999px;
        border: 2px solid var(--white);
        font-size: 0.85rem;
        font-weight: 600;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        box-shadow: 4px 4px 0 var(--black);
        opacity: 0;
        pointer-events: none;
        transition: opacity 160ms ease-out, transform 160ms ease-out;
        z-index: 10000;
      }

      .toast.visible {
        opacity: 1;
        transform: translate(-50%, -4px);
      }

      .header-author {
        font-size: 0.65rem;
        font-weight: 400;
        text-transform: none;
        letter-spacing: 0;
        margin-top: 4px;
        color: var(--black);
      }

      .social-links {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        margin-top: var(--social-links-margin-top, 24px);
      }

      .social-link {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 999px;
        border: 2px solid var(--black);
        background: #e0e0e0;
        color: var(--black);
        text-decoration: none;
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        box-shadow: 4px 4px 0 var(--black);
        transition:
          transform 120ms ease-out,
          box-shadow 120ms ease-out,
          background 120ms ease-out;
      }

      .social-link:hover {
        transform: translate(2px, 2px);
        box-shadow: 2px 2px 0 var(--black);
        background: #d0d0d0;
      }

      .social-link:active {
        transform: translate(3px, 3px);
        box-shadow: 1px 1px 0 var(--black);
      }

      /* --- COOKIE BANNER --- */
      .cookie-banner {
        position: fixed;
        bottom: 20px;
        left: 20px;
        right: 20px;
        z-index: 20000;
        display: flex;
        justify-content: center;
        pointer-events: none;
      }

      .cookie-content {
        pointer-events: auto;
        background: var(--white);
        border: 4px solid var(--black);
        box-shadow: 8px 8px 0 var(--black);
        padding: 10px;
        max-width: 500px;
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .cookie-content h3 {
        margin: 0;
        text-transform: uppercase;
        font-size: 1.1rem;
      }

      .cookie-content p {
        margin: 0;
        font-size: 0.9rem;
        line-height: 1.4;
      }

      .cookie-buttons {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }

      .cookie-btn {
        padding: 8px 16px;
        font-weight: 800;
        text-transform: uppercase;
        border: 3px solid var(--black);
        cursor: pointer;
        font-size: 0.8rem;
        box-shadow: 4px 4px 0 var(--black);
        transition: transform 0.1s, box-shadow 0.1s;
      }

      .cookie-btn:active {
        transform: translate(2px, 2px);
        box-shadow: 2px 2px 0 var(--black);
      }

      .cookie-btn.accept {
        background: var(--lime);
        color: var(--black);
      }

      .cookie-btn.reject {
        background: #ff5e5e;
        color: var(--black);
      }

      @media (max-width: 600px) {
        .cookie-banner {
            left: 10px; right: 10px; bottom: 10px;
        }
        .cookie-content {
            padding: 16px;
        }
        .cookie-buttons {
            justify-content: stretch;
        }
        .cookie-btn {
            flex: 1;
            text-align: center;
        }
      }

      /* --- NAME MODAL --- */
      .name-modal-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(5, 5, 5, 0.6);
        z-index: 30000;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
      }

      .name-modal-overlay.visible {
        opacity: 1;
        pointer-events: auto;
      }

      .name-modal {
        background: var(--white);
        border: 4px solid var(--black);
        box-shadow: 12px 12px 0 var(--black);
        padding: 24px;
        max-width: 400px;
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 16px;
        transform: scale(0.9);
        transition: transform 0.2s ease;
      }

      .name-modal-overlay.visible .name-modal {
        transform: scale(1);
      }

      .name-modal h3 {
        margin: 0;
        text-transform: uppercase;
        font-size: 1.2rem;
        font-weight: 800;
        letter-spacing: 0.06em;
      }

      .name-modal input {
        padding: 12px 16px;
        border: 3px solid var(--black);
        background: var(--white);
        font-size: 1rem;
        font-weight: 600;
        font-family: inherit;
        color: var(--black);
        box-shadow: 4px 4px 0 var(--black);
        transition: transform 0.1s, box-shadow 0.1s;
        letter-spacing: 0.05em;
      }

      .name-modal input:focus {
        outline: none;
        transform: translate(2px, 2px);
        box-shadow: 2px 2px 0 var(--black);
        background: var(--lime-soft);
      }

      .name-modal-buttons {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 8px;
      }

      .name-modal-btn {
        padding: 10px 20px;
        font-weight: 800;
        text-transform: uppercase;
        border: 3px solid var(--black);
        cursor: pointer;
        font-size: 0.85rem;
        box-shadow: 4px 4px 0 var(--black);
        transition: transform 0.1s, box-shadow 0.1s;
        font-family: inherit;
      }

      .name-modal-btn:active {
        transform: translate(2px, 2px);
        box-shadow: 2px 2px 0 var(--black);
      }

      .name-modal-btn.cancel {
        background: #e0e0e0;
        color: var(--black);
      }

      .name-modal-btn.save {
        background: var(--lime);
        color: var(--black);
      }
    </style>
  </head>
  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-N77K3KBS"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    
    <!-- Containers for the effects -->
    <div id="fireContainer" class="fx-container"></div>
    <div id="sadContainer" class="fx-container"></div>
    <div id="happyContainer" class="fx-container"></div>

    <!-- MAIN MENU -->
    <div id="mainMenu" class="app">
        <header class="header">
          <h1 style="font-size: 2.2rem; text-transform: uppercase; margin: 0; letter-spacing: 0.1em; text-align: center;">Coinfliip</h1>
          <div class="header-author" style="font-size: 0.8rem; margin-top: 8px;">Multiplayer Update</div>
        </header>
        <main class="main">
          <div class="menu-content">
            <button id="btnStoryMode" class="menu-btn">Modo Historia</button>
            
            <div class="menu-separator"></div>
            
            <button id="btnCreateRoom" class="menu-btn secondary">Crear Sala</button>
            
            <div class="menu-row">
                <input type="text" id="roomCodeInput" class="menu-input" placeholder="C√ìDIGO" maxlength="5">
                <button id="btnJoinRoom" class="menu-btn join-btn">Unirse</button>
            </div>
          </div>
        </main>
    </div>

    <!-- GAME APP (OCULTO POR DEFECTO) -->
    <div id="gameApp" class="app hidden">
      <header class="header">
        <div class="header-title">
          <div>
            Coinfliip
            <div class="header-author" id="headerAuthor">by antonio10bc</div>
          </div>
          <div class="header-badge">HEAD 49.999% / TAILS 49.999% / EDGE 0.002%</div>
        </div>

        <div class="coin-panel">
          <div class="coin-wrapper">
            <div class="speech-bubble" id="speechBubble" hidden>0</div>
            <button class="coin" id="coinButton" aria-label="Flip coin">
              <span id="coinFace">?</span>
            </button>
            <div class="coin-face-label" id="coinFaceLabel"><strong>Tap to flip</strong></div>

            <button class="claim-button" id="claimButton" disabled>
              CLAIM
            </button>
          </div>

          <div class="coin-info">
            <p>
              Each consecutive <strong>HEAD</strong> üòä doubles your score.<br />
              <strong>TAILS</strong> ‚ùå resets your streak.<br />
              <strong>EDGE</strong> ‚≠ê gives you 50000 points.<br />
              <strong>CLAIM</strong> banks your points but resets the streak.
            </p>
            <div class="result-pill" id="resultPill">
              <span id="bestStreakLabel">BEST STREAK:</span>
              <span id="bestStreakValue">0</span>
            </div>
            <div class="result-pill" id="bestClaimedPill" style="margin-top: 10px;">
              <span id="bestClaimedLabel">BEST CLAIMED STREAK:</span>
              <span id="bestClaimedValue">0</span>
            </div>
          </div>
        </div>
      </header>

      <main class="main">
        <section class="leaderboard-section">
          <div class="leaderboard-header">
            <h1>Leaderboard</h1>
          </div>
          
          <div class="leaderboard" id="leaderboard"></div>
        </section>

        <div class="social-links">
          <a href="https://www.instagram.com/antonio10bc/" target="_blank" rel="noopener noreferrer" class="social-link">Instagram</a>
          <a href="https://www.paypal.com/paypalme/antonio10bc" target="_blank" rel="noopener noreferrer" class="social-link">Donate</a>
        </div>
      </main>
    </div>

    <div class="toast" id="toast">EDGE IMPOSSIBLE (?)</div>

    <script>
      (function () {
        // --- 1. FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDBqaofgjviMoq_YSaFuXMVmSm-47KzvOM",
            authDomain: "coinfliip-multiplayer.firebaseapp.com",
            databaseURL: "https://coinfliip-multiplayer-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "coinfliip-multiplayer",
            storageBucket: "coinfliip-multiplayer.firebasestorage.app",
            messagingSenderId: "634679701084",
            appId: "1:634679701084:web:1c036b210224f2a41cc099"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Generate or retrieve a persistent User ID for this session
        let userId = localStorage.getItem('coinfliip_userId');
        if (!userId) {
            userId = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('coinfliip_userId', userId);
        }

        // --- GAME VARIABLES ---
        window.dataLayer = window.dataLayer || [];
        function sendAnalyticsEvent(eventName, params = {}) {
          window.dataLayer.push({ event: eventName, ...params, });
        }

        let totalFlips = 0;
        let headsCount = 0;
        let tailsCount = 0;
        let edgesCount = 0;
        let currentPoints = 0; 
        let bestCombo = 0; 
        let bestClaimedCombo = 0; 
        let ctaTimeoutId = null; 
        let currentGameMode = null; // 'story' or 'multiplayer'
        let currentRoomId = null;
        let roomSubscription = null;

        // --- DOM ELEMENTS ---
        const mainMenu = document.getElementById('mainMenu');
        const gameApp = document.getElementById('gameApp');
        const btnStoryMode = document.getElementById('btnStoryMode');
        const btnCreateRoom = document.getElementById('btnCreateRoom');
        const btnJoinRoom = document.getElementById('btnJoinRoom');
        const roomCodeInput = document.getElementById('roomCodeInput');
        const headerAuthor = document.getElementById('headerAuthor');

        const coinButton = document.getElementById('coinButton');
        const coinFace = document.getElementById('coinFace');
        const coinFaceLabel = document.getElementById('coinFaceLabel');
        const speechBubble = document.getElementById('speechBubble');
        const claimButton = document.getElementById('claimButton');
        const leaderboardEl = document.getElementById('leaderboard');
        const resultPill = document.getElementById('resultPill');
        const bestClaimedPill = document.getElementById('bestClaimedPill');
        const resultPillValue = document.getElementById('bestStreakValue');
        const bestClaimedValue = document.getElementById('bestClaimedValue');
        const toast = document.getElementById('toast');
        const fireContainer = document.getElementById('fireContainer');
        const sadContainer = document.getElementById('sadContainer');
        const happyContainer = document.getElementById('happyContainer');

        // --- LANGUAGE & LOCALIZATION ---
        const isSpanish = (navigator.language || navigator.userLanguage || '').toLowerCase().startsWith('es');
        
        if (isSpanish) {
            document.documentElement.lang = 'es';
            // Translate Menu
            btnStoryMode.textContent = 'Modo Historia';
            btnCreateRoom.textContent = 'Crear Sala';
            btnJoinRoom.textContent = 'Unirse';
            roomCodeInput.placeholder = 'C√ìDIGO';
            
            // Translate Game
            const headerBadge = document.querySelector('.header-badge');
            if (headerBadge) headerBadge.textContent = 'CARA 49.999% / CRUZ 49.999% / CANTO 0.002%';
            coinButton.setAttribute('aria-label', 'Lanzar moneda');
            coinFaceLabel.innerHTML = '<strong>Toca para lanzar</strong>';
            const rulesParagraph = document.querySelector('.coin-info p');
            if (rulesParagraph) {
              rulesParagraph.innerHTML =
                'Cada <strong>CARA</strong> üòä consecutiva dobla tu marcador.<br />' +
                '<strong>CRUZ</strong> ‚ùå reinicia tu racha.<br />' +
                '<strong>CANTO</strong> ‚≠ê te da 50000 puntos.<br />' +
                '<strong>COBRAR</strong> guarda tus puntos pero reinicia la racha.';
            }
            const bestStreakLabel = document.getElementById('bestStreakLabel');
            if (bestStreakLabel) bestStreakLabel.textContent = 'MEJOR RACHA:';
            const bestClaimedLabel = document.getElementById('bestClaimedLabel');
            if (bestClaimedLabel) bestClaimedLabel.textContent = 'MEJOR RACHA COBRADA:';
            const leaderboardTitle = document.querySelector('.leaderboard-header h1');
            if (leaderboardTitle) leaderboardTitle.textContent = 'Clasificaci√≥n';
            toast.textContent = '¬øCANTO IMPOSIBLE?';
            claimButton.textContent = 'COBRAR';
            if (headerAuthor) headerAuthor.textContent = 'por antonio10bc';
            
            const btnAccept = document.getElementById('btnAccept');
            const btnReject = document.getElementById('btnReject');
            if (btnAccept) btnAccept.textContent = 'Aceptar';
            if (btnReject) btnReject.textContent = 'Denegar';
        } else {
            // Translate Menu
            btnStoryMode.textContent = 'Story Mode';
            btnCreateRoom.textContent = 'Create Room';
            btnJoinRoom.textContent = 'Join Room';
            roomCodeInput.placeholder = 'CODE';

            document.documentElement.lang = 'en';
            coinButton.setAttribute('aria-label', 'Flip coin');
            const btnAccept = document.getElementById('btnAccept');
            const btnReject = document.getElementById('btnReject');
            if (btnAccept) btnAccept.textContent = 'Accept';
            if (btnReject) btnReject.textContent = 'Reject';
        }

        const SOCIAL_LINKS_MARGIN_TOP = 24;
        document.documentElement.style.setProperty('--social-links-margin-top', SOCIAL_LINKS_MARGIN_TOP + 'px');

        // --- CONSTANTS ---
        const P_HEADS = 49.999;
        const P_TAILS = 49.999;
        const P_EDGE = 0.002;
        const P_TOTAL = P_HEADS + P_TAILS + P_EDGE; 

        // --- HISTORICAL DATA ---
        const historicalNamesEn = ["Antonio Bastos de C√≥rdoba","Malala Yousafzai","Tim Berners-Lee","Rigoberta Mench√∫","Valentina Tereshkova","Gabriel Garcia Marquez","Nelson Mandela","Rosa Parks","The Beatles","Deng Xiaoping","Simone de Beauvoir","Charlie Chaplin","Mao Zedong","Pablo Picasso","Kwame Nkrumah","Martin Luther King Jr.","Walt Disney","Winston Churchill","Eleanor Roosevelt","Rosalind Franklin","Albert Einstein","Alexander Fleming","Alan Turing","Frida Kahlo","Mahatma Gandhi","The Wright Brothers","Franklin D. Roosevelt","Nikola Tesla","George Washington Carver","Sigmund Freud","Mustafa Kemal Ataturk","Marie Curie","Fritz Haber","Emmeline Pankhurst","Lenin","Harriet Tubman","Florence Nightingale","Queen Victoria","Louis Pasteur","Karl Marx","Charles Darwin","Abraham Lincoln","Ada Lovelace","Jos√© de San Mart√≠n","Sim√≥n Bol√≠var","Ludwig van Beethoven","Napoleon Bonaparte","James Watt","Immanuel Kant","George Washington","Catherine the Great","Wolfgang Amadeus Mozart","Jean-Jacques Rousseau","Voltaire","Isaac Newton","Ren√© Descartes","Galileo Galilei","William Shakespeare","Miguel de Cervantes","Suleiman the Magnificent","Michelangelo","Martin Luther","Nicolaus Copernicus","Guru Nanak","Vasco da Gama","Leonardo da Vinci","Christopher Columbus","Isabella I of Castile","Johannes Gutenberg","Mansa Musa","Dante Alighieri","Thomas Aquinas","Genghis Khan","Saladin","Avicenna","Murasaki Shikibu","Al-Khwarizmi","Charlemagne","Wu Zetian","Muhammad","Cai Lun","Jesus of Nazareth","Augustus","Cleopatra","Julius Caesar","Qin Shi Huang","Ashoka","Alexander the Great","Aristotle","Plato","Socrates","Confucius","Buddha","Cyrus the Great","Laozi","Homer","Zoroaster","Moses","Hatshepsut"];
        const historicalNamesEs = ["Antonio Bastos de C√≥rdoba","Malala Yousafzai","Tim Berners-Lee","Rigoberta Mench√∫","Valentina Tereshkova","Gabriel Garc√≠a M√°rquez","Nelson Mandela","Rosa Parks","The Beatles","Deng Xiaoping","Simone de Beauvoir","Charlie Chaplin","Mao Zedong","Pablo Picasso","Kwame Nkrumah","Martin Luther King Jr.","Walt Disney","Winston Churchill","Eleanor Roosevelt","Rosalind Franklin","Albert Einstein","Alexander Fleming","Alan Turing","Frida Kahlo","Mahatma Gandhi","Los Hermanos Wright","Franklin D. Roosevelt","Nikola Tesla","George Washington Carver","Sigmund Freud","Mustafa Kemal Ataturk","Marie Curie","Fritz Haber","Emmeline Pankhurst","Lenin","Harriet Tubman","Florence Nightingale","Reina Victoria","Louis Pasteur","Karl Marx","Charles Darwin","Abraham Lincoln","Ada Lovelace","Jos√© de San Mart√≠n","Sim√≥n Bol√≠var","Ludwig van Beethoven","Napole√≥n Bonaparte","James Watt","Immanuel Kant","George Washington","Catalina la Grande","Wolfgang Amadeus Mozart","Jean-Jacques Rousseau","Voltaire","Isaac Newton","Ren√© Descartes","Galileo Galilei","William Shakespeare","Miguel de Cervantes","Solim√°n el Magn√≠fico","Miguel √Ångel","Mart√≠n Lutero","Nicol√°s Cop√©rnico","Guru Nanak","Vasco de Gama","Leonardo da Vinci","Crist√≥bal Col√≥n","Isabel I de Castilla","Johannes Gutenberg","Mansa Musa","Dante Alighieri","Tom√°s de Aquino","Gengis Kan","Saladino","Avicena","Murasaki Shikibu","Al-Juarismi","Carlomagno","Wu Zetian","Mahoma","Cai Lun","Jes√∫s de Nazaret","Augusto","Cleopatra","Julio C√©sar","Qin Shi Huang","Ashoka","Alejandro Magno","Arist√≥teles","Plat√≥n","S√≥crates","Confucio","Buda","Ciro el Grande","Laozi","Homero","Zoroastro","Mois√©s","Hatshepsut"];
        const historicalNames = isSpanish ? historicalNamesEs : historicalNamesEn;

        // --- PLAYERS DATA ---
        let players = [];
        let currentPlayerName = isSpanish ? 'T√∫' : 'You';
        
        // --- GAME LOGIC FUNCTIONS ---

        function initPlayers(mode) {
          players = [];
          
          if (mode === 'story') {
             // User
            players.push({ id: 'user', name: currentPlayerName, score: 0, isUser: true, lastRank: 0 });
            // Add historical bots
            for (let i = 0; i < historicalNames.length; i++) {
                const score = Math.floor(999 - (i * (999 / (historicalNames.length - 1))));
                players.push({
                  id: 'historical' + i,
                  name: historicalNames[i],
                  score: score,
                  isUser: false,
                  lastRank: 0 
                });
            }
            // Sort initially
            const initialSorted = players.slice().sort((a, b) => b.score - a.score);
            initialSorted.forEach((p, i) => p.lastRank = i + 1);
            
            // Try to load saved data for story mode
            loadGameData();
            
            // Re-sync current player name after load
            const user = players.find(p => p.isUser);
            if (user) currentPlayerName = user.name;
          } 
          // For multiplayer, players array is populated via subscription
        }

        // --- 3. ROOM LOGIC & START GAME ---
        function startGame(mode) {
            currentGameMode = mode;
            
            if (mode === 'story') {
                initPlayers('story');
                updateLeaderboard();
                mainMenu.classList.add('hidden');
                gameApp.classList.remove('hidden');
                updateSpeechBubble();
                updateBestCombo();
                updateBestClaimedCombo();
                scheduleIdleCta();
                sendAnalyticsEvent('start_game', { mode: 'story' });
                if(headerAuthor) headerAuthor.textContent = isSpanish ? 'por antonio10bc' : 'by antonio10bc';
                
            } else if (mode === 'multiplayer_create') {
                // a. Generate 5-char code
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // No O, 0, I, 1 to avoid confusion
                let code = '';
                for (let i = 0; i < 5; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
                currentRoomId = code;

                // b. Set initial data for this user in the new room
                // We use localStorage name if available from previous sessions (loaded in story mode part, or default)
                // Let's check if we have a saved name from story mode to use it here too
                try {
                    const savedData = JSON.parse(localStorage.getItem('coinfliip_gameData') || '{}');
                    if (savedData.playersScores) {
                         const u = savedData.playersScores.find(p => p.id === 'user');
                         if (u && u.name) currentPlayerName = u.name;
                    }
                } catch(e){}

                db.ref('rooms/' + currentRoomId + '/players/' + userId).set({
                    name: currentPlayerName,
                    score: 0
                }).then(() => {
                    // c. Subscribe
                    subscribeToRoom(currentRoomId);
                    
                    // d. Show code
                    headerAuthor.textContent = (isSpanish ? 'C√ìDIGO SALA: ' : 'ROOM CODE: ') + currentRoomId;
                    headerAuthor.style.fontWeight = '800';
                    headerAuthor.style.color = 'var(--black)';
                    
                    // e. Show game
                    mainMenu.classList.add('hidden');
                    gameApp.classList.remove('hidden');
                    
                    // Reset visual scores for new game
                    currentPoints = 0;
                    bestCombo = 0;
                    bestClaimedCombo = 0;
                    updateSpeechBubble();
                    updateBestCombo();
                    updateBestClaimedCombo();
                    scheduleIdleCta();
                });

            } else if (mode === 'multiplayer_join') {
                // a. Read input
                const code = roomCodeInput.value.trim().toUpperCase();
                if (!code) return;

                // b. Check if exists
                db.ref('rooms/' + code).get().then((snapshot) => {
                    if (snapshot.exists()) {
                        currentRoomId = code;
                        
                        // Get name preference
                         try {
                            const savedData = JSON.parse(localStorage.getItem('coinfliip_gameData') || '{}');
                            if (savedData.playersScores) {
                                 const u = savedData.playersScores.find(p => p.id === 'user');
                                 if (u && u.name) currentPlayerName = u.name;
                            }
                        } catch(e){}

                        // c. Join room
                        db.ref('rooms/' + currentRoomId + '/players/' + userId).set({
                            name: currentPlayerName,
                            score: 0
                        }).then(() => {
                            subscribeToRoom(currentRoomId);
                             headerAuthor.textContent = (isSpanish ? 'C√ìDIGO SALA: ' : 'ROOM CODE: ') + currentRoomId;
                             headerAuthor.style.fontWeight = '800';

                             mainMenu.classList.add('hidden');
                             gameApp.classList.remove('hidden');

                            currentPoints = 0;
                            bestCombo = 0;
                            bestClaimedCombo = 0;
                            updateSpeechBubble();
                            updateBestCombo();
                            updateBestClaimedCombo();
                            scheduleIdleCta();
                        });
                    } else {
                        // d. Error
                        showToast(isSpanish ? "SALA NO ENCONTRADA" : "ROOM NOT FOUND");
                    }
                }).catch((error) => {
                    console.error(error);
                    showToast("ERROR");
                });
            }
        }

        // --- 4. REALTIME SYNC ---
        function subscribeToRoom(roomId) {
            if (roomSubscription) {
                // Detach previous listener if any
                db.ref('rooms/' + roomId + '/players').off();
            }

            roomSubscription = db.ref('rooms/' + roomId + '/players').on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) {
                    players = [];
                    updateLeaderboard();
                    return;
                }

                // Rebuild players array
                // We preserve previous ranks to allow the animation logic to work
                const oldPlayers = [...players];
                players = [];

                Object.keys(data).forEach(key => {
                    const pData = data[key];
                    // Try to find this player in old array to keep 'lastRank' if possible, though logic might reset
                    const oldP = oldPlayers.find(op => op.id === key);
                    
                    players.push({
                        id: key,
                        name: pData.name || 'Unknown',
                        score: pData.score || 0,
                        isUser: (key === userId),
                        lastRank: oldP ? oldP.lastRank : 0
                    });
                });
                
                // If the user name changed in another device or via modal, update local variable
                const me = players.find(p => p.isUser);
                if (me) currentPlayerName = me.name;

                updateLeaderboard();
            });
        }

        // --- EFFECTS ---
        function updateFireEffect(score) {
          fireContainer.innerHTML = ''; 
          if (score < 2) return;
          const streakLevel = Math.log2(score);
          const count = Math.floor(streakLevel * 12); 
          const fragment = document.createDocumentFragment();

          for (let i = 0; i < count; i++) {
            const el = document.createElement('div');
            el.textContent = 'üî•';
            el.className = 'fire-particle';
            const size = 1.5 + Math.random() * 2.0;
            el.style.fontSize = size + 'rem';
            const side = Math.floor(Math.random() * 4); 
            const offset = 10 + Math.random() * 80; 
            const depth = (Math.random() * 10 - 5) + 'px';

            switch(side) {
                case 0: el.style.top = depth; el.style.left = offset + '%'; break;
                case 1: el.style.right = depth; el.style.top = offset + '%'; break;
                case 2: el.style.bottom = depth; el.style.left = offset + '%'; break;
                case 3: el.style.left = depth; el.style.top = offset + '%'; break;
            }
            el.style.animationDelay = (Math.random() * 1) + 's';
            fragment.appendChild(el);
          }
          fireContainer.appendChild(fragment);
        }
        
        function triggerSadness() {
          sadContainer.innerHTML = ''; 
          const fragment = document.createDocumentFragment();
          for (let i = 0; i < 15; i++) {
            const el = document.createElement('div');
            el.textContent = 'üò¢';
            el.className = 'sad-particle';
            el.style.left = (Math.random() * 100) + 'vw';
            el.style.top = (Math.random() * 80) + 'vh'; 
            el.style.animationDuration = (0.6 + Math.random() * 0.3) + 's';
            fragment.appendChild(el);
          }
          sadContainer.appendChild(fragment);
          setTimeout(() => { sadContainer.innerHTML = ''; }, 850);
        }

        function triggerHappiness() {
          happyContainer.innerHTML = '';
          const fragment = document.createDocumentFragment();
          const happyEmojis = ['ü§©', 'üòÑ'];
          for (let i = 0; i < 20; i++) {
            const el = document.createElement('div');
            el.textContent = happyEmojis[Math.floor(Math.random() * happyEmojis.length)];
            el.className = 'happy-particle';
            el.style.left = (Math.random() * 100) + 'vw';
            el.style.top = (50 + Math.random() * 40) + 'vh';
            el.style.animationDuration = (0.8 + Math.random() * 0.4) + 's';
            fragment.appendChild(el);
          }
          happyContainer.appendChild(fragment);
          setTimeout(() => { happyContainer.innerHTML = ''; }, 1300);
        }

        function triggerHighlight(element) {
          if (!element) return;
          element.classList.add('highlight');
          setTimeout(() => { element.classList.remove('highlight'); }, 1000);
        }

        // --- DATA PERSISTENCE ---
        function saveGameData() {
          if (currentGameMode !== 'story') return; // Only save locally in story mode
          
          const user = players.find(p => p.isUser);
          const gameData = {
            userScore: user ? user.score : 0,
            bestCombo: bestCombo,
            bestClaimedCombo: bestClaimedCombo,
            playersScores: players.map(p => ({
              id: p.id,
              score: p.score,
              name: p.isUser ? p.name : undefined 
            }))
          };
          try {
            localStorage.setItem('coinfliip_gameData', JSON.stringify(gameData));
          } catch (e) { console.warn('Could not save game data:', e); }
        }

        function loadGameData() {
          try {
            const savedData = localStorage.getItem('coinfliip_gameData');
            if (savedData) {
              const gameData = JSON.parse(savedData);
              const user = players.find(p => p.isUser);
              if (user) {
                user.score = gameData.userScore || 0;
                if (gameData.playersScores) {
                  const savedUser = gameData.playersScores.find(p => p.id === 'user');
                  if (savedUser && savedUser.name) {
                    user.name = savedUser.name;
                  }
                }
              }
              bestCombo = gameData.bestCombo || 0;
              bestClaimedCombo = gameData.bestClaimedCombo || 0;
              
              if (gameData.playersScores) {
                gameData.playersScores.forEach(savedPlayer => {
                  const player = players.find(p => p.id === savedPlayer.id);
                  if (player && !player.isUser) {
                    player.score = savedPlayer.score || player.score;
                  }
                });
              }
              return true;
            }
          } catch (e) { console.warn('Could not load game data:', e); }
          return false;
        }

        // --- GAMEPLAY ---
        function rollOutcome() {
          const r = Math.random() * P_TOTAL;
          if (r < P_HEADS) return 'cara';
          if (r < P_HEADS + P_TAILS) return 'cruz';
          return 'canto';
        }

        function showToast(message) {
          toast.textContent = message;
          toast.classList.add('visible');
          setTimeout(function () { toast.classList.remove('visible'); }, 1300);
        }

        function updateSpeechBubble() {
          if (currentPoints > 0) {
            speechBubble.hidden = false;
            speechBubble.textContent = String(currentPoints);
          } else {
            speechBubble.hidden = true;
          }
        }

        function updateBestCombo() { resultPillValue.textContent = String(bestCombo); }
        function updateBestClaimedCombo() { bestClaimedValue.textContent = String(bestClaimedCombo); }

        function resetStreak() {
          currentPoints = 0;
          updateSpeechBubble();
          updateFireEffect(0); 
          claimButton.disabled = true;
        }

        function formatScore(score) { return score.toLocaleString('es-ES'); }

        // --- NAME MODAL ---
        let nameModalHandlers = null;
        function showNameModal(player) {
          const overlay = document.getElementById('nameModalOverlay');
          const input = document.getElementById('nameModalInput');
          const title = document.getElementById('nameModalTitle');
          const cancelBtn = document.getElementById('nameModalCancel');
          const saveBtn = document.getElementById('nameModalSave');
          
          if (!overlay) return;
          
          if (nameModalHandlers) {
            saveBtn.removeEventListener('click', nameModalHandlers.save);
            cancelBtn.removeEventListener('click', nameModalHandlers.cancel);
            input.removeEventListener('keydown', nameModalHandlers.keydown);
            overlay.removeEventListener('click', nameModalHandlers.overlay);
          }
          
          input.value = player.name;
          input.maxLength = 10;
          
          if (isSpanish) {
            title.textContent = 'Cambiar nombre';
            cancelBtn.textContent = 'Cancelar';
            saveBtn.textContent = 'Guardar';
            input.placeholder = 'M√°x. 10 caracteres';
          } else {
            title.textContent = 'Change name';
            cancelBtn.textContent = 'Cancel';
            saveBtn.textContent = 'Save';
            input.placeholder = 'Max. 10 characters';
          }
          
          const handleSave = function() {
            const trimmedName = input.value.trim().substring(0, 10);
            if (trimmedName.length > 0) {
              player.name = trimmedName;
              currentPlayerName = trimmedName; // Update local global var
              
              if (currentGameMode === 'story') {
                 saveGameData();
                 updateLeaderboard();
              } else if (currentGameMode.startsWith('multiplayer')) {
                 // Update name in firebase
                 db.ref('rooms/' + currentRoomId + '/players/' + userId).update({
                     name: trimmedName
                 });
                 // Leaderboard updates via subscription
              }
            }
            hideNameModal();
          };
          
          const handleCancel = function() { hideNameModal(); };
          
          const handleKeyPress = function(e) {
            if (e.key === 'Enter') { e.preventDefault(); handleSave(); } 
            else if (e.key === 'Escape') { e.preventDefault(); handleCancel(); }
          };
          
          const handleOverlayClick = function(e) { if (e.target === overlay) handleCancel(); };
          
          nameModalHandlers = { save: handleSave, cancel: handleCancel, keydown: handleKeyPress, overlay: handleOverlayClick };
          
          saveBtn.addEventListener('click', handleSave);
          cancelBtn.addEventListener('click', handleCancel);
          input.addEventListener('keydown', handleKeyPress);
          overlay.addEventListener('click', handleOverlayClick);
          
          overlay.classList.add('visible');
          setTimeout(() => { input.focus(); input.select(); }, 50);
        }
        
        function hideNameModal() {
          const overlay = document.getElementById('nameModalOverlay');
          if (overlay) overlay.classList.remove('visible');
        }

        // --- LEADERBOARD ---
        function updateLeaderboard() {
          if (!players || players.length === 0) {
              leaderboardEl.innerHTML = '';
              return;
          }
            
          const sorted = players.slice().sort((a, b) => b.score - a.score);
          leaderboardEl.innerHTML = '';
          let userPosition = null;

          for (let i = 0; i < sorted.length; i++) {
            const player = sorted[i];
            const currentRank = i + 1;
            const previousRank = player.lastRank;
            
            const row = document.createElement('div');
            row.className = 'leaderboard-row' + (player.isUser ? ' is-user' : '');

            const pos = document.createElement('div');
            pos.className = 'leaderboard-pos';
            pos.textContent = currentRank + '.';

            const name = document.createElement('div');
            name.className = 'leaderboard-name';
            name.textContent = player.name;
            
            if (player.isUser) {
              userPosition = currentRank;
              name.style.cursor = 'pointer';
              name.title = isSpanish ? 'Toca para cambiar tu nombre' : 'Click to change your name';
              name.addEventListener('click', function() { showNameModal(player); });
              const tag = document.createElement('span');
              tag.className = 'leaderboard-tag';
              tag.textContent = isSpanish ? 'T√∫' : 'You';
              name.appendChild(tag);
            }

            let trendIcon = document.createElement('span');
            trendIcon.className = 'trend-icon';
            let hasChanged = false;
            
            if (previousRank !== 0 && currentRank !== previousRank) {
                if (currentRank < previousRank) {
                    trendIcon.textContent = '‚ñ≤'; trendIcon.classList.add('trend-up');
                } else {
                    trendIcon.textContent = '‚ñº'; trendIcon.classList.add('trend-down');
                }
                hasChanged = true;
            } else { trendIcon.textContent = ''; }
            
            player.lastRank = currentRank;
            name.appendChild(trendIcon);

            if (hasChanged) {
                trendIcon.classList.add('visible');
                setTimeout(() => { if (trendIcon) trendIcon.classList.remove('visible'); }, 60000);
            }

            const score = document.createElement('div');
            score.className = 'leaderboard-score';
            score.textContent = formatScore(player.score);

            row.appendChild(pos); row.appendChild(name); row.appendChild(score);
            leaderboardEl.appendChild(row);
          }
          return userPosition;
        }

        function randomBotProgress(claimValue) {
          if (claimValue <= 0 || currentGameMode !== 'story') return;
          for (let i = 0; i < players.length; i++) {
            const p = players[i];
            if (p.isUser) continue;
            const delta = Math.floor(Math.random() * (claimValue * 0.75));
            p.score += delta;
          }
        }

        function scheduleIdleCta() {
          if (ctaTimeoutId !== null) clearTimeout(ctaTimeoutId);
          coinFaceLabel.classList.remove('cta');
          ctaTimeoutId = setTimeout(function () { coinFaceLabel.classList.add('cta'); }, 5000);
        }

        function handleCoinClick() {
          coinFace.textContent = '';
          coinFaceLabel.textContent = isSpanish ? 'Lanzando...' : 'Flipping...';
          coinFaceLabel.classList.remove('cta');

          setTimeout(function () {
            const outcome = rollOutcome();
            let flipResult = '';
            
            if (outcome === 'cara') {
              flipResult = 'HEAD';
              headsCount++;
              coinFace.innerHTML = '<strong>üòä</strong>';
              coinFaceLabel.textContent = isSpanish ? 'Cara' : 'Heads';
              currentPoints = currentPoints === 0 ? 1 : currentPoints * 2;
              if (currentPoints > bestCombo) {
                bestCombo = currentPoints;
                if (currentGameMode === 'story') saveGameData();
                triggerHighlight(resultPill);
              }
              claimButton.disabled = false;
              updateFireEffect(currentPoints);

            } else if (outcome === 'cruz') {
              flipResult = 'TAILS';
              tailsCount++;
              coinFace.innerHTML = '<strong>‚ùå</strong>';
              coinFaceLabel.textContent = isSpanish ? 'Cruz (reinicio)' : 'Tails (reset)';
              if (currentPoints >= 2) triggerSadness();
              resetStreak();

            } else {
              flipResult = 'EDGE';
              edgesCount++;
              coinFace.innerHTML = '<strong>‚≠ê</strong>';
              coinFaceLabel.textContent = isSpanish ? 'Canto (raro)' : 'Edge (rare)';
              currentPoints += 50000;
              if (currentPoints > bestCombo) {
                bestCombo = currentPoints;
                if (currentGameMode === 'story') saveGameData();
                triggerHighlight(resultPill);
              }
              claimButton.disabled = false;
              showToast(isSpanish ? '‚≠ê ¬°CANTO! +50000 puntos' : '‚≠ê EDGE! +50000 points');
              updateFireEffect(currentPoints);
            }

            totalFlips++;
            const user = players.find(p => p.isUser);
            sendAnalyticsEvent('coin_flip', {
              flip_result: flipResult,
              current_streak: currentPoints,
              best_streak: bestCombo,
              score: user ? user.score : 0
            });

            updateSpeechBubble();
            updateBestCombo();
            scheduleIdleCta();
          }, 110);
        }

        // --- 5. UPDATED CLAIM CLICK ---
        function handleClaimClick() {
          if (currentPoints <= 0) return;
          const user = players.find(p => p.isUser);
          if (!user && currentGameMode === 'story') return; 
          // In multiplayer user object is in players array too

          sendAnalyticsEvent('claim_click', { current_streak: currentPoints });

          if (currentPoints > bestClaimedCombo) {
            bestClaimedCombo = currentPoints;
            triggerHighlight(bestClaimedPill);
          }
          
          // Update score
          let newScore = 0;
          if (user) {
              user.score += currentPoints;
              newScore = user.score;
          }

          triggerHappiness();
          
          if (currentGameMode === 'story') {
              randomBotProgress(currentPoints);
              const leaderboardPosition = updateLeaderboard();
              saveGameData();
              
          } else if (currentGameMode.startsWith('multiplayer')) {
              // Firebase Update
              db.ref('rooms/' + currentRoomId + '/players/' + userId).update({
                  score: newScore
              });
              // No manual leaderboard update needed, on('value') handles it
          }

          sendAnalyticsEvent('run_stats', {
            best_streak: bestCombo,
            best_claimed_streak: bestClaimedCombo,
            // leaderboard_position: leaderboardPosition, // Hard to calc async
            total_flips: totalFlips
          });

          const pointsText = isSpanish
            ? (currentPoints === 1 ? ' punto' : ' puntos')
            : (currentPoints === 1 ? ' point' : ' points');
          showToast(isSpanish ? 'Has cobrado ' + currentPoints + pointsText : 'You claimed ' + currentPoints + pointsText);

          resetStreak();
          coinFace.textContent = '?';
          coinFaceLabel.innerHTML = isSpanish ? '<strong>Toca para lanzar</strong>' : '<strong>Tap to flip</strong>';
          scheduleIdleCta();
          updateBestClaimedCombo();
        }

        // --- EVENT LISTENERS ---
        coinButton.addEventListener('click', handleCoinClick);
        claimButton.addEventListener('click', handleClaimClick);
        
        // Menu Listeners
        btnStoryMode.addEventListener('click', () => startGame('story'));
        btnCreateRoom.addEventListener('click', () => startGame('multiplayer_create'));
        btnJoinRoom.addEventListener('click', () => startGame('multiplayer_join'));

        const instagramLink = document.querySelector('.social-link[href*="instagram"]');
        const donateLink = document.querySelector('.social-link[href*="paypal"]');

        if (instagramLink) instagramLink.addEventListener('click', function() { sendAnalyticsEvent('social_click', { social_platform: 'instagram' }); });
        if (donateLink) donateLink.addEventListener('click', function() { sendAnalyticsEvent('social_click', { social_platform: 'donate' }); });

      })();
    </script>
    <div id="cookieBanner" class="cookie-banner" style="display: none;">
        <div class="cookie-content">
          <h3>üç™ Cookies & Privacy</h3>
          <p>We use cookies to improve your experience.</p>
          <div class="cookie-buttons">
            <button id="btnReject" class="cookie-btn reject">Denegar</button>
            <button id="btnAccept" class="cookie-btn accept">Aceptar</button>
          </div>
        </div>
      </div>

    <!-- Name Edit Modal -->
    <div id="nameModalOverlay" class="name-modal-overlay">
      <div class="name-modal">
        <h3 id="nameModalTitle">Change name</h3>
        <input type="text" id="nameModalInput" maxlength="10" />
        <div class="name-modal-buttons">
          <button id="nameModalCancel" class="name-modal-btn cancel">Cancel</button>
          <button id="nameModalSave" class="name-modal-btn save">Save</button>
        </div>
      </div>
    </div>
      <script>
        (function() {
          const cookieBanner = document.getElementById('cookieBanner');
          const btnAccept = document.getElementById('btnAccept');
          const btnReject = document.getElementById('btnReject');
          const GTM_ID = 'GTM-N77K3KBS'; 
      
          function loadGTM() {
            (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
            })(window,document,'script','dataLayer', GTM_ID);
          }
      
          const consent = localStorage.getItem('cookieConsent');
          if (consent === 'true') { loadGTM(); } 
          else if (consent === 'false') { } 
          else { cookieBanner.style.display = 'flex'; }
      
          btnAccept.addEventListener('click', function() {
            localStorage.setItem('cookieConsent', 'true');
            cookieBanner.style.display = 'none';
            loadGTM();
          });
      
          btnReject.addEventListener('click', function() {
            localStorage.setItem('cookieConsent', 'false');
            cookieBanner.style.display = 'none';
          });
        })();
      </script>
  </body>
</html>